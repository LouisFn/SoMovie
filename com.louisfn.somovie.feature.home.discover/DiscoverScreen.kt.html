<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DiscoverScreen.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SoMovie</a> &gt; <a href="index.source.html" class="el_package">com.louisfn.somovie.feature.home.discover</a> &gt; <span class="el_source">DiscoverScreen.kt</span></div><h1>DiscoverScreen.kt</h1><pre class="source lang-java linenums">package com.louisfn.somovie.feature.home.discover

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.BoxScope
import androidx.compose.foundation.layout.WindowInsets
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.statusBars
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.ExperimentalMaterialApi
import androidx.compose.material.FractionalThreshold
import androidx.compose.material.Icon
import androidx.compose.material.MaterialTheme
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.Clear
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.coerceAtMost
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import coil.compose.AsyncImagePainter
import com.louisfn.somovie.feature.home.discover.DiscoverUiState.Discover.LogInSnackbarState
import com.louisfn.somovie.feature.home.discover.DiscoverUiState.MovieItem
import com.louisfn.somovie.ui.common.extension.collectAsStateLifecycleAware
import com.louisfn.somovie.ui.common.extension.pxToDp
import com.louisfn.somovie.ui.common.extension.top
import com.louisfn.somovie.ui.common.model.ImmutableList
import com.louisfn.somovie.ui.common.modifier.shake
import com.louisfn.somovie.ui.component.AutosizeText
import com.louisfn.somovie.ui.component.DefaultAsyncImage
import com.louisfn.somovie.ui.component.DefaultSnackbar
import com.louisfn.somovie.ui.component.IndeterminateProgressIndicator
import com.louisfn.somovie.ui.component.Retry
import com.louisfn.somovie.ui.component.swipe.SwipeContainer
import com.louisfn.somovie.ui.component.swipe.SwipeDirection
import com.louisfn.somovie.ui.common.R as commonR

private const val MaxMovieItemToPreload = 5
private const val SwipeFractionalThreshold = 0.25f

@Composable
internal fun DiscoverScreen(
<span class="nc" id="L59">    viewModel: DiscoverViewModel = hiltViewModel(),</span>
<span class="nc bnc" id="L60" title="All 4 branches missed.">    showAccount: () -&gt; Unit = {},</span>
<span class="nc bnc" id="L61" title="All 20 branches missed.">) {</span>
<span class="nc" id="L62">    val uiState by viewModel.uiState.collectAsStateLifecycleAware()</span>

<span class="nc bnc" id="L64" title="All 2 branches missed.">    DiscoverScreen(</span>
<span class="nc" id="L65">        uiState = uiState,</span>
<span class="nc" id="L66">        onSwiped = viewModel::onMovieSwiped,</span>
<span class="nc" id="L67">        onDisappeared = viewModel::onMovieDisappeared,</span>
<span class="nc" id="L68">        retry = { viewModel.retry() },</span>
<span class="nc" id="L69">        onLogInSnackbarActionClicked = { showAccount() },</span>
    )
<span class="nc bnc" id="L71" title="All 2 branches missed.">}</span>

@Composable
private fun DiscoverScreen(
    uiState: DiscoverUiState,
    onSwiped: (MovieItem, SwipeDirection) -&gt; Unit,
    onDisappeared: (MovieItem) -&gt; Unit,
    retry: () -&gt; Unit,
    onLogInSnackbarActionClicked: () -&gt; Unit,
<span class="nc bnc" id="L80" title="All 26 branches missed.">) {</span>
<span class="nc" id="L81">    Box(</span>
<span class="nc" id="L82">        modifier = Modifier.fillMaxSize(),</span>
    ) {
<span class="nc" id="L84">        when (uiState) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            is DiscoverUiState.Discover -&gt; DiscoverContent(</span>
<span class="nc" id="L86">                items = uiState.items,</span>
<span class="nc" id="L87">                logInSnackbarState = uiState.logInSnackbarState,</span>
<span class="nc" id="L88">                onSwiped = onSwiped,</span>
<span class="nc" id="L89">                onDisappeared = onDisappeared,</span>
<span class="nc" id="L90">                onLogInSnackbarActionClicked = onLogInSnackbarActionClicked,</span>
            )
<span class="nc bnc" id="L92" title="All 2 branches missed.">            is DiscoverUiState.Retry -&gt; Retry(</span>
<span class="nc" id="L93">                modifier = Modifier.align(Alignment.Center),</span>
<span class="nc" id="L94">                onClick = retry,</span>
            )
<span class="nc bnc" id="L96" title="All 2 branches missed.">            is DiscoverUiState.Loading -&gt; IndeterminateProgressIndicator(</span>
<span class="nc" id="L97">                modifier = Modifier.align(Alignment.Center),</span>
            )
<span class="nc bnc" id="L99" title="All 2 branches missed.">            is DiscoverUiState.None -&gt; Unit</span>
<span class="nc" id="L100">        }</span>
<span class="nc" id="L101">    }</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">}</span>

@Composable
private fun BoxScope.DiscoverContent(
    items: ImmutableList&lt;MovieItem&gt;,
    logInSnackbarState: LogInSnackbarState,
    onSwiped: (MovieItem, SwipeDirection) -&gt; Unit,
    onDisappeared: (MovieItem) -&gt; Unit,
    onLogInSnackbarActionClicked: () -&gt; Unit,
<span class="nc bnc" id="L111" title="All 30 branches missed.">) {</span>
<span class="nc" id="L112">    DiscoverSwipeContainer(</span>
<span class="nc" id="L113">        items = items,</span>
<span class="nc" id="L114">        onSwiped = onSwiped,</span>
<span class="nc" id="L115">        onDisappeared = onDisappeared,</span>
    )
<span class="nc bnc" id="L117" title="All 2 branches missed.">    if (logInSnackbarState != LogInSnackbarState.HIDDEN) {</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        DefaultSnackbar(</span>
<span class="nc" id="L119">            message = stringResource(id = commonR.string.discover_log_in_description),</span>
<span class="nc" id="L120">            actionLabel = stringResource(id = commonR.string.discover_log_in_action),</span>
<span class="nc" id="L121">            onActionClick = onLogInSnackbarActionClicked,</span>
<span class="nc" id="L122">            modifier = Modifier</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                .shake(logInSnackbarState == LogInSnackbarState.SHAKING)</span>
<span class="nc" id="L124">                .align(Alignment.BottomCenter),</span>
        )
    }
<span class="nc bnc" id="L127" title="All 2 branches missed.">}</span>

@OptIn(ExperimentalMaterialApi::class)
@Composable
private fun BoxScope.DiscoverSwipeContainer(
    items: ImmutableList&lt;MovieItem&gt;,
    onSwiped: (MovieItem, SwipeDirection) -&gt; Unit,
    onDisappeared: (MovieItem) -&gt; Unit,
<span class="nc bnc" id="L135" title="All 22 branches missed.">) {</span>
<span class="nc" id="L136">    var draggingState by remember { mutableStateOf&lt;DraggingState?&gt;(null) }</span>

<span class="nc" id="L138">    SwipeContainer(</span>
<span class="nc" id="L139">        items = ImmutableList(items.take(MaxMovieItemToPreload)),</span>
<span class="nc" id="L140">        itemKey = MovieItem::id,</span>
<span class="nc" id="L141">        thresholdConfig = FractionalThreshold(SwipeFractionalThreshold),</span>
<span class="nc" id="L142">        onDragging = { _, direction, ratio -&gt;</span>
<span class="nc" id="L143">            draggingState = DraggingState(direction, ratio)</span>
<span class="nc" id="L144">        },</span>
<span class="nc" id="L145">        onCanceled = { draggingState = null },</span>
<span class="nc" id="L146">        onSwiped = { item, direction -&gt;</span>
<span class="nc" id="L147">            draggingState = null</span>
<span class="nc" id="L148">            onSwiped(item, direction)</span>
<span class="nc" id="L149">        },</span>
<span class="nc" id="L150">        onDisappeared = { item, _ -&gt; onDisappeared(item) },</span>
<span class="nc" id="L151">    ) { item -&gt;</span>
<span class="nc bnc" id="L152" title="All 8 branches missed.">        DiscoverMovieItem(item)</span>
<span class="nc" id="L153">    }</span>

<span class="nc bnc" id="L155" title="All 4 branches missed.">    draggingState?.let { DiscoverSwipeIcon(it) }</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L159" title="All 14 branches missed.">private fun BoxScope.DiscoverSwipeIcon(draggingState: DraggingState) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">    Icon(</span>
<span class="nc" id="L161">        modifier = Modifier</span>
<span class="nc" id="L162">            .align(Alignment.Center)</span>
<span class="nc" id="L163">            .size(draggingState.iconSize)</span>
<span class="nc" id="L164">            .clip(CircleShape)</span>
<span class="nc" id="L165">            .background(draggingState.iconBackgroundColor),</span>
<span class="nc" id="L166">        imageVector = draggingState.icon,</span>
<span class="nc" id="L167">        contentDescription = null,</span>
    )
<span class="nc bnc" id="L169" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L172" title="All 10 branches missed.">private fun DiscoverMovieItem(item: MovieItem) {</span>
<span class="nc" id="L173">    var isImageLoaded by remember { mutableStateOf(false) }</span>

<span class="nc" id="L175">    Box {</span>
<span class="nc" id="L176">        DefaultAsyncImage(</span>
<span class="nc" id="L177">            modifier = Modifier</span>
<span class="nc" id="L178">                .fillMaxSize()</span>
<span class="nc" id="L179">                .background(MaterialTheme.colors.background),</span>
<span class="nc" id="L180">            contentScale = ContentScale.Crop,</span>
<span class="nc" id="L181">            model = item.posterPath,</span>
<span class="nc" id="L182">            onState = { isImageLoaded = it is AsyncImagePainter.State.Success },</span>
        )
<span class="nc" id="L184">        AutosizeText(</span>
<span class="nc" id="L185">            modifier = Modifier</span>
<span class="nc" id="L186">                .fillMaxWidth()</span>
<span class="nc" id="L187">                .background(MaterialTheme.colors.background.copy(alpha = 0.8f))</span>
<span class="nc" id="L188">                .padding(top = WindowInsets.statusBars.top.pxToDp())</span>
<span class="nc" id="L189">                .padding(horizontal = 24.dp, vertical = 8.dp),</span>
<span class="nc" id="L190">            text = item.title,</span>
<span class="nc" id="L191">            style = MaterialTheme.typography.h3,</span>
<span class="nc" id="L192">            textAlign = TextAlign.Center,</span>
<span class="nc" id="L193">            maxLines = 2,</span>
        )
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (!isImageLoaded) {</span>
<span class="nc" id="L196">            IndeterminateProgressIndicator(</span>
<span class="nc" id="L197">                modifier = Modifier</span>
<span class="nc" id="L198">                    .size(32.dp)</span>
<span class="nc" id="L199">                    .align(Alignment.Center),</span>
            )
        }
<span class="nc" id="L202">    }</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">}</span>

<span class="nc" id="L205">private data class DraggingState(</span>
<span class="nc" id="L206">    val direction: SwipeDirection,</span>
<span class="nc" id="L207">    val ratio: Float,</span>
) {

    val icon: ImageVector
        @Composable
<span class="nc bnc" id="L212" title="All 4 branches missed.">        get() = when (direction) {</span>
<span class="nc" id="L213">            SwipeDirection.LEFT -&gt; Icons.Default.Clear</span>
<span class="nc" id="L214">            SwipeDirection.RIGHT -&gt; Icons.Default.Add</span>
        }

    val iconBackgroundColor: Color
        @Composable
<span class="nc bnc" id="L219" title="All 5 branches missed.">        get() = when (direction) {</span>
<span class="nc" id="L220">            SwipeDirection.LEFT -&gt; MaterialTheme.colors.discoverDisliked</span>
<span class="nc" id="L221">            SwipeDirection.RIGHT -&gt; MaterialTheme.colors.discoverLiked</span>
        }

<span class="nc" id="L224">    val iconSize: Dp =</span>
<span class="nc" id="L225">        (MAX_ICON_SIZE * ratio / SwipeFractionalThreshold).coerceAtMost(MAX_ICON_SIZE)</span>

    companion object {
<span class="nc" id="L228">        private val MAX_ICON_SIZE = 64.dp</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>