<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DiscoverViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SoMovie</a> &gt; <a href="index.source.html" class="el_package">com.louisfn.somovie.feature.home.discover</a> &gt; <span class="el_source">DiscoverViewModel.kt</span></div><h1>DiscoverViewModel.kt</h1><pre class="source lang-java linenums">package com.louisfn.somovie.feature.home.discover

import androidx.annotation.AnyThread
import androidx.lifecycle.viewModelScope
import com.louisfn.somovie.core.common.Result
import com.louisfn.somovie.core.common.annotation.DefaultDispatcher
import com.louisfn.somovie.core.common.asFlowResult
import com.louisfn.somovie.core.common.data
import com.louisfn.somovie.core.common.extension.safeCollect
import com.louisfn.somovie.core.common.isError
import com.louisfn.somovie.core.common.isLoading
import com.louisfn.somovie.core.common.onResultError
import com.louisfn.somovie.domain.model.Movie
import com.louisfn.somovie.domain.usecase.authentication.AuthenticationInteractor
import com.louisfn.somovie.domain.usecase.movie.MovieDiscoverInteractor
import com.louisfn.somovie.domain.usecase.watchlist.WatchlistInteractor
import com.louisfn.somovie.feature.home.discover.DiscoverUiState.Discover.LogInSnackbarState
import com.louisfn.somovie.feature.home.discover.DiscoverUiState.MovieItem
import com.louisfn.somovie.ui.common.base.BaseViewModel
import com.louisfn.somovie.ui.common.base.NoneAction
import com.louisfn.somovie.ui.common.error.ErrorsDispatcher
import com.louisfn.somovie.ui.common.model.ImmutableList
import com.louisfn.somovie.ui.component.swipe.SwipeDirection
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.combine
import kotlinx.coroutines.flow.filterNotNull
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.flow.getAndUpdate
import kotlinx.coroutines.flow.map
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
<span class="nc" id="L42">internal class DiscoverViewModel @Inject constructor(</span>
    @DefaultDispatcher defaultDispatcher: CoroutineDispatcher,
<span class="nc" id="L44">    private val movieDiscoverInteractor: MovieDiscoverInteractor,</span>
<span class="nc" id="L45">    private val watchlistInteractor: WatchlistInteractor,</span>
<span class="nc" id="L46">    private val authenticationInteractor: AuthenticationInteractor,</span>
<span class="nc" id="L47">    private val movieItemMapper: DiscoverMovieItemMapper,</span>
<span class="nc" id="L48">    private val errorsDispatcher: ErrorsDispatcher,</span>
<span class="nc" id="L49">) : BaseViewModel&lt;NoneAction&gt;(defaultDispatcher) {</span>

<span class="nc" id="L51">    private val moviesState = MutableStateFlow(emptyList&lt;Movie&gt;())</span>
<span class="nc" id="L52">    private val fetchNewMoviesResultState = MutableStateFlow&lt;Result&lt;List&lt;Movie&gt;&gt;?&gt;(null)</span>
<span class="nc" id="L53">    private val isLogInSnackbarShaking = MutableStateFlow(false)</span>
    private val isLoggedIn: Flow&lt;Boolean&gt; =
<span class="nc" id="L55">        authenticationInteractor.isLoggedIn()</span>
<span class="nc" id="L56">            .stateIn(viewModelScope, SharingStarted.Lazily, null)</span>
<span class="nc" id="L57">            .filterNotNull()</span>

<span class="nc" id="L59">    val uiState: StateFlow&lt;DiscoverUiState&gt; =</span>
<span class="nc" id="L60">        combine(</span>
<span class="nc" id="L61">            moviesState.map(movieItemMapper::map),</span>
<span class="nc" id="L62">            fetchNewMoviesResultState,</span>
<span class="nc" id="L63">            isLoggedIn,</span>
<span class="nc" id="L64">            isLogInSnackbarShaking,</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        ) { items, fetchNewMoviesResultState, isLoggedIn, isLogInSnackbarShaking -&gt;</span>
<span class="nc" id="L66">            createDiscoverUiState(</span>
<span class="nc" id="L67">                items = items,</span>
<span class="nc" id="L68">                fetchMovieResultState = fetchNewMoviesResultState,</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                isLoggedIn = isLoggedIn,</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                isLogInSnackbarShaking = isLogInSnackbarShaking,</span>
            )
        }
<span class="nc" id="L73">            .stateIn(</span>
<span class="nc" id="L74">                scope = viewModelScope,</span>
<span class="nc" id="L75">                started = SharingStarted.WhileSubscribed(),</span>
<span class="nc" id="L76">                initialValue = DiscoverUiState.None,</span>
            )

<span class="nc" id="L79">    init {</span>
<span class="nc" id="L80">        fetchNewDiscoverMovies()</span>
<span class="nc" id="L81">    }</span>

    @AnyThread
    private fun createDiscoverUiState(
        items: ImmutableList&lt;MovieItem&gt;,
        fetchMovieResultState: Result&lt;List&lt;Movie&gt;&gt;?,
        isLoggedIn: Boolean,
        isLogInSnackbarShaking: Boolean,
<span class="nc" id="L89">    ): DiscoverUiState = when {</span>
<span class="nc bnc" id="L90" title="All 4 branches missed.">        items.isNotEmpty() -&gt; DiscoverUiState.Discover(</span>
<span class="nc" id="L91">            items = items,</span>
<span class="nc" id="L92">            logInSnackbarState = when {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                isLoggedIn -&gt; LogInSnackbarState.HIDDEN</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">                isLogInSnackbarShaking -&gt; LogInSnackbarState.SHAKING</span>
<span class="nc" id="L95">                else -&gt; LogInSnackbarState.VISIBLE</span>
            },
        )
<span class="nc bnc" id="L98" title="All 2 branches missed.">        fetchMovieResultState.isLoading -&gt; DiscoverUiState.Loading</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        fetchMovieResultState.isError -&gt; DiscoverUiState.Retry</span>
<span class="nc" id="L100">        else -&gt; DiscoverUiState.None</span>
<span class="nc" id="L101">    }</span>

    @AnyThread
    fun onMovieSwiped(movieItem: MovieItem, direction: SwipeDirection) {
<span class="nc" id="L105">        viewModelScope.launch(defaultDispatcher) {</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">            if (direction.shouldAddMovieToWatchlist()) {</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                if (!isLoggedIn.first()) {</span>
<span class="nc" id="L108">                    shakeLogInSnackbar()</span>
<span class="nc" id="L109">                    return@launch</span>
                }
<span class="nc" id="L111">                addToWatchlist(movieItem)</span>
            }
<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">    }</span>

    @AnyThread
    fun onMovieDisappeared(movieItem: MovieItem) {
<span class="nc bnc" id="L118" title="All 2 branches missed.">        viewModelScope.launch(defaultDispatcher) {</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            moviesState.update { movies -&gt; movies.filter { it.id != movieItem.id } }</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (moviesState.value.size &lt;= MIN_MOVIE_COUNT_BEFORE_FETCH) {</span>
<span class="nc" id="L122">                fetchNewDiscoverMovies()</span>
            }
<span class="nc" id="L124">        }</span>
<span class="nc" id="L125">    }</span>

    @AnyThread
    fun retry() {
<span class="nc" id="L129">        fetchNewDiscoverMovies()</span>
<span class="nc" id="L130">    }</span>

    @AnyThread
    private fun fetchNewDiscoverMovies() {
<span class="nc" id="L134">        viewModelScope.launch(defaultDispatcher) {</span>
<span class="nc" id="L135">            val currentState = fetchNewMoviesResultState.getAndUpdate { Result.Loading() }</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (currentState !is Result.Loading) {</span>
<span class="nc" id="L137">                asFlowResult { movieDiscoverInteractor.getDiscoverMovies() }</span>
<span class="nc" id="L138">                    .onResultError(errorsDispatcher::dispatch)</span>
<span class="nc" id="L139">                    .safeCollect(</span>
                        onEach = { result -&gt;
                            moviesState.update { it + result.data.orEmpty() }
                            fetchNewMoviesResultState.emit(result)
                        },
<span class="nc" id="L144">                        onError = errorsDispatcher::dispatch,</span>
                    )
            }
<span class="nc" id="L147">        }</span>
<span class="nc" id="L148">    }</span>

    @AnyThread
    private suspend fun addToWatchlist(movieItem: MovieItem) {
<span class="nc" id="L152">        try {</span>
<span class="nc" id="L153">            watchlistInteractor.addToWatchlist(movieItem.id)</span>
<span class="nc" id="L154">        } catch (e: Exception) {</span>
<span class="nc" id="L155">            errorsDispatcher.dispatch(e)</span>
        }
<span class="nc" id="L157">    }</span>

    @AnyThread
    private suspend fun shakeLogInSnackbar() {
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (isLogInSnackbarShaking.compareAndSet(expect = false, update = true)) {</span>
<span class="nc" id="L162">            delay(SHAKE_DELAY)</span>
<span class="nc" id="L163">            isLogInSnackbarShaking.value = false</span>
        }
<span class="nc" id="L165">    }</span>

    @AnyThread
<span class="nc bnc" id="L168" title="All 2 branches missed.">    private fun SwipeDirection.shouldAddMovieToWatchlist() = this == SwipeDirection.RIGHT</span>

    companion object {
        private const val MIN_MOVIE_COUNT_BEFORE_FETCH = 5
        private const val SHAKE_DELAY = 1000L
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>