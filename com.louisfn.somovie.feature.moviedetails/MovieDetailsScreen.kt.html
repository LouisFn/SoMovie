<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MovieDetailsScreen.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SoMovie</a> &gt; <a href="index.source.html" class="el_package">com.louisfn.somovie.feature.moviedetails</a> &gt; <span class="el_source">MovieDetailsScreen.kt</span></div><h1>MovieDetailsScreen.kt</h1><pre class="source lang-java linenums">package com.louisfn.somovie.feature.moviedetails

import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.BoxScope
import androidx.compose.foundation.layout.PaddingValues
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material.Button
import androidx.compose.material.ButtonDefaults
import androidx.compose.material.Icon
import androidx.compose.material.MaterialTheme
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.PlaylistAdd
import androidx.compose.material.icons.filled.PlaylistRemove
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.layout.LayoutCoordinates
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.constraintlayout.compose.ConstraintLayout
import androidx.constraintlayout.compose.Dimension
import androidx.hilt.navigation.compose.hiltViewModel
import com.louisfn.somovie.core.common.extension.safeLet
import com.louisfn.somovie.domain.model.BackdropPath
import com.louisfn.somovie.domain.model.MovieGenre
import com.louisfn.somovie.domain.model.PosterPath
import com.louisfn.somovie.feature.moviedetails.WatchlistFabState.WatchlistState
import com.louisfn.somovie.feature.moviedetails.poster.MovieDetailsPosterFullScreen
import com.louisfn.somovie.ui.common.extension.collectAsStateLifecycleAware
import com.louisfn.somovie.ui.common.model.ImmutableList
import com.louisfn.somovie.ui.component.IndeterminateProgressIndicator
import com.louisfn.somovie.ui.component.Retry
import com.louisfn.somovie.ui.theme.AppTheme
import java.time.Duration

@Composable
internal fun MovieDetailsScreen(
<span class="nc" id="L44">    viewModel: MovieDetailsViewModel = hiltViewModel(),</span>
    navigateUp: () -&gt; Unit,
<span class="nc bnc" id="L46" title="All 20 branches missed.">) {</span>
<span class="nc" id="L47">    val state by viewModel.uiState.collectAsStateLifecycleAware()</span>

<span class="nc bnc" id="L49" title="All 2 branches missed.">    MovieDetailsScreen(</span>
<span class="nc" id="L50">        state = state,</span>
<span class="nc" id="L51">        onRetryClick = viewModel::retry,</span>
<span class="nc" id="L52">        onWatchlistFabClick = viewModel::switchWatchlistState,</span>
<span class="nc" id="L53">        navigateUp = navigateUp,</span>
    )
<span class="nc bnc" id="L55" title="All 2 branches missed.">}</span>

@Composable
private fun MovieDetailsScreen(
    state: MovieDetailsUiState,
    onRetryClick: () -&gt; Unit,
    onWatchlistFabClick: () -&gt; Unit,
    navigateUp: () -&gt; Unit,
<span class="nc bnc" id="L63" title="All 22 branches missed.">) {</span>
<span class="nc" id="L64">    var posterReducedCoordinates by remember { mutableStateOf&lt;LayoutCoordinates?&gt;(null) }</span>

<span class="nc bnc" id="L66" title="All 6 branches missed.">    val headerUiState = state.headerUiState ?: return Box {}</span>

<span class="nc" id="L68">    Box {</span>
<span class="nc" id="L69">        ConstraintLayout(</span>
<span class="nc" id="L70">            modifier = Modifier.fillMaxSize(),</span>
        ) {
            val (header, content, watchlistFab) = createRefs()

            MovieDetailsHeader(
                headerUiState = headerUiState,
                modifier = Modifier.constrainAs(header) {
<span class="nc" id="L77">                    top.linkTo(parent.top)</span>
<span class="nc" id="L78">                    start.linkTo(parent.start)</span>
<span class="nc" id="L79">                    end.linkTo(parent.end)</span>
<span class="nc" id="L80">                },</span>
                navigateUp = navigateUp,
<span class="nc" id="L82">                onPosterPositioned = { posterReducedCoordinates = it },</span>
            )

            Box(
                modifier = Modifier
                    .constrainAs(content) {
<span class="nc" id="L88">                        top.linkTo(header.bottom)</span>
<span class="nc" id="L89">                        start.linkTo(parent.start)</span>
<span class="nc" id="L90">                        end.linkTo(parent.end)</span>
<span class="nc" id="L91">                        bottom.linkTo(parent.bottom)</span>
<span class="nc" id="L92">                        height = Dimension.fillToConstraints</span>
<span class="nc" id="L93">                    },</span>
            ) {
                state.contentUiState?.let {
                    MovieDetailsScreen(contentUiState = it, onRetryClick = onRetryClick)
                }
            }

            state.watchlistFabState?.let {
                AddToWatchlistSmallFab(
                    watchlistFabState = it,
                    modifier = Modifier
                        .constrainAs(watchlistFab) {
<span class="nc" id="L105">                            top.linkTo(header.bottom)</span>
<span class="nc" id="L106">                            bottom.linkTo(header.bottom)</span>
<span class="nc" id="L107">                            end.linkTo(parent.end, 12.dp)</span>
<span class="nc" id="L108">                        },</span>
                    onClick = onWatchlistFabClick,
                )
            }
        }

<span class="nc bnc" id="L114" title="All 2 branches missed.">        safeLet(posterReducedCoordinates, state.headerUiState.posterPath) { coordinates, path -&gt;</span>
<span class="nc" id="L115">            MovieDetailsPosterFullScreen(</span>
<span class="nc" id="L116">                posterPath = path,</span>
<span class="nc" id="L117">                posterReducedCoordinates = coordinates,</span>
            )
<span class="nc" id="L119">        }</span>
<span class="nc" id="L120">    }</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">}</span>

@Composable
private fun AddToWatchlistSmallFab(
    watchlistFabState: WatchlistFabState,
<span class="nc bnc" id="L126" title="All 2 branches missed.">    modifier: Modifier = Modifier,</span>
    onClick: () -&gt; Unit,
<span class="nc bnc" id="L128" title="All 24 branches missed.">) {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">    Button(</span>
<span class="nc" id="L130">        onClick = onClick,</span>
<span class="nc" id="L131">        modifier = modifier</span>
<span class="nc" id="L132">            .size(48.dp),</span>
<span class="nc" id="L133">        contentPadding = PaddingValues(0.dp),</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        enabled = !watchlistFabState.isLoading,</span>
<span class="nc" id="L135">        shape = CircleShape,</span>
<span class="nc" id="L136">        colors = ButtonDefaults</span>
<span class="nc" id="L137">            .buttonColors(</span>
<span class="nc bnc" id="L138" title="All 3 branches missed.">                backgroundColor = when (watchlistFabState.state) {</span>
<span class="nc" id="L139">                    WatchlistState.ADD_TO_WATCHLIST -&gt; MaterialTheme.colors.secondary</span>
<span class="nc" id="L140">                    WatchlistState.REMOVE_FROM_WATCHLIST -&gt; MaterialTheme.colors.error</span>
                },
            ),
<span class="nc" id="L143">    ) {</span>
<span class="nc bnc" id="L144" title="All 8 branches missed.">        Icon(</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">            imageVector = when (watchlistFabState.state) {</span>
<span class="nc" id="L146">                WatchlistState.ADD_TO_WATCHLIST -&gt; Icons.Filled.PlaylistAdd</span>
<span class="nc" id="L147">                WatchlistState.REMOVE_FROM_WATCHLIST -&gt; Icons.Filled.PlaylistRemove</span>
            },
<span class="nc" id="L149">            tint = MaterialTheme.colors.onPrimary,</span>
<span class="nc" id="L150">            contentDescription = &quot;&quot;,</span>
<span class="nc" id="L151">        )</span>
<span class="nc" id="L152">    }</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L156" title="All 18 branches missed.">private fun BoxScope.MovieDetailsScreen(contentUiState: ContentUiState, onRetryClick: () -&gt; Unit) {</span>
<span class="nc" id="L157">    when (contentUiState) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        is ContentUiState.Content -&gt; MovieDetailsScreen(state = contentUiState)</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">        is ContentUiState.Loading -&gt; MovieDetailsLoader(</span>
<span class="nc" id="L160">            modifier = Modifier.align(Alignment.Center),</span>
        )
<span class="nc bnc" id="L162" title="All 2 branches missed.">        is ContentUiState.Retry -&gt; MovieDetailsRetry(</span>
<span class="nc" id="L163">            modifier = Modifier.align(Alignment.Center),</span>
<span class="nc" id="L164">            onClick = onRetryClick,</span>
        )
<span class="nc bnc" id="L166" title="All 2 branches missed.">    }</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L170" title="All 14 branches missed.">private fun MovieDetailsLoader(modifier: Modifier = Modifier) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">    IndeterminateProgressIndicator(</span>
<span class="nc" id="L172">        modifier = modifier,</span>
    )
<span class="nc bnc" id="L174" title="All 2 branches missed.">}</span>

@Composable
<span class="nc bnc" id="L177" title="All 20 branches missed.">private fun MovieDetailsRetry(modifier: Modifier = Modifier, onClick: () -&gt; Unit) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">    Retry(</span>
<span class="nc" id="L179">        modifier = modifier,</span>
<span class="nc" id="L180">        onClick = onClick,</span>
    )
<span class="nc bnc" id="L182" title="All 2 branches missed.">}</span>

@Preview
@Composable
<span class="nc bnc" id="L186" title="All 6 branches missed.">private fun MovieDetailScreenPreview() {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">    AppTheme {</span>
<span class="nc bnc" id="L188" title="All 8 branches missed.">        MovieDetailsScreen(</span>
<span class="nc" id="L189">            state = MovieDetailsUiState(</span>
<span class="nc" id="L190">                headerUiState = HeaderUiState(</span>
<span class="nc" id="L191">                    title = &quot;Spider-Man: No Way Home&quot;,</span>
<span class="nc" id="L192">                    posterPath = PosterPath(&quot;/1g0dhYtq4irTY1GPXvft6k4YLjm.jpg&quot;),</span>
<span class="nc" id="L193">                    backdropPaths = ImmutableList(</span>
<span class="nc" id="L194">                        listOf(</span>
<span class="nc" id="L195">                            BackdropPath(&quot;/iQFcwSGbZXMkeyKrxbPnwnRo5fl.jpg&quot;),</span>
<span class="nc" id="L196">                            BackdropPath(&quot;/iQFcwSGbZXMkeyKrxbPnwnRo5fp.jpg&quot;),</span>
<span class="nc" id="L197">                            BackdropPath(&quot;/iQFcwSGbZXMkeyKrxbPnwnRo5fs.jpg&quot;),</span>
                        ),
                    ),
<span class="nc" id="L200">                    tagline = &quot;The Multiverse unleashed.&quot;,</span>
<span class="nc" id="L201">                    voteAverage = 8.4f,</span>
<span class="nc" id="L202">                    voteCount = 7997,</span>
<span class="nc" id="L203">                    tmdbUrl = &quot;&quot;,</span>
<span class="nc" id="L204">                    releaseDate = &quot;2021/12/15&quot;,</span>
                ),
<span class="nc" id="L206">                contentUiState = ContentUiState.Content(</span>
<span class="nc" id="L207">                    originalTitle = &quot;Spider-Man: No Way Home&quot;,</span>
<span class="nc" id="L208">                    originalLanguage = &quot;en&quot;,</span>
<span class="nc" id="L209">                    overview = &quot;Peter Parker is unmasked and no longer able to separate his normal life from the &quot; +</span>
<span class="nc" id="L210">                        &quot;high-stakes of being a super-hero. When he asks for help from Doctor Strange the stakes &quot; +</span>
<span class="nc" id="L211">                        &quot;become even more dangerous, forcing him to discover what it truly means to be Spider-Man.&quot;,</span>
<span class="nc" id="L212">                    runtime = Duration.ofMillis(148),</span>
<span class="nc" id="L213">                    popularity = 7683.216f,</span>
<span class="nc" id="L214">                    budget = &quot;200000000&quot;,</span>
<span class="nc" id="L215">                    revenue = &quot;1804372547&quot;,</span>
<span class="nc" id="L216">                    crew = ImmutableList(emptyList()),</span>
<span class="nc" id="L217">                    cast = ImmutableList(emptyList()),</span>
<span class="nc" id="L218">                    genres = ImmutableList(</span>
<span class="nc" id="L219">                        listOf(</span>
<span class="nc" id="L220">                            MovieGenre(</span>
<span class="nc" id="L221">                                id = 1,</span>
<span class="nc" id="L222">                                name = &quot;Action&quot;,</span>
                            ),
<span class="nc" id="L224">                            MovieGenre(</span>
<span class="nc" id="L225">                                id = 2,</span>
<span class="nc" id="L226">                                name = &quot;Adventure&quot;,</span>
                            ),
<span class="nc" id="L228">                            MovieGenre(</span>
<span class="nc" id="L229">                                id = 3,</span>
<span class="nc" id="L230">                                name = &quot;Science Fiction&quot;,</span>
                            ),
                        ),
                    ),
<span class="nc" id="L234">                    videos = ImmutableList(),</span>
                ),
<span class="nc" id="L236">                watchlistFabState = WatchlistFabState(</span>
<span class="nc" id="L237">                    isLoading = true,</span>
<span class="nc" id="L238">                    state = WatchlistState.REMOVE_FROM_WATCHLIST,</span>
                ),
            ),
<span class="nc" id="L241">            onRetryClick = {},</span>
<span class="nc" id="L242">            onWatchlistFabClick = {},</span>
<span class="nc" id="L243">            navigateUp = {},</span>
<span class="nc" id="L244">        )</span>
<span class="nc" id="L245">    }</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>