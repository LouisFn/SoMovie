<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WatchlistViewModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SoMovie</a> &gt; <a href="index.source.html" class="el_package">com.louisfn.somovie.feature.home.watchlist</a> &gt; <span class="el_source">WatchlistViewModel.kt</span></div><h1>WatchlistViewModel.kt</h1><pre class="source lang-java linenums">package com.louisfn.somovie.feature.home.watchlist

import androidx.annotation.AnyThread
import androidx.annotation.WorkerThread
import androidx.lifecycle.viewModelScope
import androidx.paging.*
import com.louisfn.somovie.core.common.annotation.ApplicationScope
import com.louisfn.somovie.core.common.annotation.DefaultDispatcher
import com.louisfn.somovie.core.common.extension.takeAs
import com.louisfn.somovie.core.logger.Logger
import com.louisfn.somovie.domain.model.Movie
import com.louisfn.somovie.domain.usecase.authentication.AuthenticationInteractor
import com.louisfn.somovie.domain.usecase.watchlist.WatchlistInteractor
import com.louisfn.somovie.feature.home.watchlist.WatchlistUiState.AccountLoggedIn.ContentState
import com.louisfn.somovie.feature.home.watchlist.WatchlistUiState.AccountLoggedIn.LoadNextPageState
import com.louisfn.somovie.ui.common.base.BaseViewModel
import com.louisfn.somovie.ui.common.error.ErrorsDispatcher
import com.louisfn.somovie.ui.common.extension.isError
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.CoroutineDispatcher
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.NonCancellable
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.combine
import kotlinx.coroutines.flow.filter
import kotlinx.coroutines.flow.flatMapLatest
import kotlinx.coroutines.flow.flowOf
import kotlinx.coroutines.flow.flowOn
import kotlinx.coroutines.flow.map
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import kotlinx.coroutines.withTimeout
import java.util.concurrent.CopyOnWriteArrayList
import javax.inject.Inject

@HiltViewModel
<span class="fc" id="L42">internal class WatchlistViewModel @Inject constructor(</span>
    @DefaultDispatcher defaultDispatcher: CoroutineDispatcher,
<span class="fc" id="L44">    private val authenticationInteractor: AuthenticationInteractor,</span>
<span class="fc" id="L45">    private val watchlistInteractor: WatchlistInteractor,</span>
<span class="fc" id="L46">    private val errorsDispatcher: ErrorsDispatcher,</span>
<span class="fc" id="L47">    @ApplicationScope private val applicationScope: CoroutineScope,</span>
<span class="fc" id="L48">) : BaseViewModel&lt;WatchlistAction&gt;(defaultDispatcher) {</span>

<span class="fc" id="L50">    private val pagingState = MutableStateFlow&lt;PagingState?&gt;(null)</span>
<span class="fc" id="L51">    private val hiddenMovieItemIds = MutableStateFlow(emptyList&lt;Long&gt;())</span>
<span class="fc" id="L52">    private val pendingSwipedMovieItemIds = CopyOnWriteArrayList&lt;Long&gt;()</span>

    //region UiState

    private val accountLoggedInUiState: Flow&lt;WatchlistUiState.AccountLoggedIn&gt; =
<span class="fc" id="L57">        pagingState</span>
<span class="fc" id="L58">            .map(::createUiState)</span>

    private val accountDisconnectedUiState: Flow&lt;WatchlistUiState.AccountDisconnected&gt; =
<span class="fc" id="L61">        flowOf(WatchlistUiState.AccountDisconnected)</span>

<span class="fc" id="L63">    val uiState: StateFlow&lt;WatchlistUiState&gt; =</span>
<span class="fc" id="L64">        authenticationInteractor.isLoggedIn()</span>
<span class="fc" id="L65">            .flatMapLatest {</span>
                if (it) {
                    accountLoggedInUiState
                } else {
                    accountDisconnectedUiState
                }
            }
<span class="fc" id="L72">            .stateIn(</span>
<span class="fc" id="L73">                scope = viewModelScope,</span>
<span class="fc" id="L74">                started = SharingStarted.WhileSubscribed(),</span>
<span class="fc" id="L75">                initialValue = WatchlistUiState.None,</span>
            )

    //endregion

    //region Paged movies

    private val pagedMovies =
<span class="fc" id="L83">        watchlistInteractor.watchlistPagingChanges()</span>
<span class="fc" id="L84">            .cachedIn(viewModelScope)</span>

<span class="fc" id="L86">    val pagedMovieItems =</span>
<span class="fc" id="L87">        authenticationInteractor.isLoggedIn()</span>
<span class="fc" id="L88">            .filter { it }</span>
<span class="fc" id="L89">            .flatMapLatest {</span>
                combine(
                    pagedMovies,
                    hiddenMovieItemIds,
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">                ) { paged, hiddenItemIds -&gt;</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">                    paged.map { movie -&gt;</span>
<span class="fc" id="L95">                        MovieItem(movie = movie, isHidden = movie.id in hiddenItemIds)</span>
                    }
                }
                    .flowOn(defaultDispatcher)
            }

    //endregion

    @AnyThread
    fun onViewHidden() {
<span class="fc" id="L105">        removeAllPendingSwipedMovieFromWatchlist()</span>
<span class="fc" id="L106">    }</span>

    @AnyThread
    private fun createUiState(pagingState: PagingState?): WatchlistUiState.AccountLoggedIn {
<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (pagingState == null) {</span>
<span class="fc" id="L111">            return WatchlistUiState.AccountLoggedIn()</span>
        }

<span class="fc" id="L114">        val refreshLoadState = pagingState.loadStates.refresh</span>
<span class="fc" id="L115">        val appendLoadState = pagingState.loadStates.append</span>

<span class="fc" id="L117">        return WatchlistUiState.AccountLoggedIn(</span>
<span class="fc" id="L118">            contentState = when {</span>
<span class="fc bfc" id="L119" title="All 4 branches covered.">                pagingState.itemCount == 0 &amp;&amp; refreshLoadState.isError -&gt; ContentState.RETRY</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">                pagingState.itemCount == 0 -&gt; ContentState.LOADING</span>
<span class="fc" id="L121">                else -&gt; ContentState.SUCCESS</span>
            },
<span class="fc" id="L123">            loadNextPageState = when (appendLoadState) {</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">                is LoadState.Error -&gt; LoadNextPageState.RETRY</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">                is LoadState.Loading -&gt; LoadNextPageState.LOADING</span>
<span class="fc" id="L126">                is LoadState.NotLoading -&gt; LoadNextPageState.IDLE</span>
            },
        )
    }

    //region Paging state

    @AnyThread
    fun onLoadStateChanged(loadStates: CombinedLoadStates, itemCount: Int) {
<span class="fc" id="L135">        pagingState.value = PagingState(loadStates, itemCount)</span>

<span class="fc bfc" id="L137" title="All 2 branches covered.">        loadStates.refresh.takeAs&lt;LoadState.Error&gt;()?.let {</span>
<span class="fc" id="L138">            onPagingError(it.error)</span>
<span class="fc" id="L139">        }</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">        loadStates.append.takeAs&lt;LoadState.Error&gt;()?.let {</span>
<span class="fc" id="L141">            onPagingError(it.error)</span>
<span class="fc" id="L142">        }</span>
<span class="fc" id="L143">    }</span>

    @AnyThread
    fun onPagingError(e: Throwable) {
<span class="fc" id="L147">        errorsDispatcher.dispatch(e)</span>
<span class="fc" id="L148">    }</span>

    //endregion

    //region Remove from watchlist

    @AnyThread
    fun onSwipeToDismiss(movie: Movie) {
<span class="fc" id="L156">        viewModelScope.launch(defaultDispatcher) {</span>
<span class="fc" id="L157">            addAsHidden(movie.id)</span>
<span class="fc" id="L158">            addAsPendingSwiped(movie.id)</span>
<span class="fc" id="L159">            emitAction(WatchlistAction.ShowUndoSwipeToDismissSnackbar(movie.id))</span>
<span class="fc" id="L160">        }</span>
<span class="fc" id="L161">    }</span>

    @AnyThread
    fun onUndoSwipeToDismissSnackbarDismissed(movieId: Long) {
<span class="fc" id="L165">        viewModelScope.launch(defaultDispatcher) {</span>
<span class="fc" id="L166">            removeAsPendingSwiped(movieId)</span>
<span class="fc" id="L167">            removeFromWatchlist(movieId)</span>
<span class="fc" id="L168">        }</span>
<span class="fc" id="L169">    }</span>

    @AnyThread
    fun onUndoSwipeToDismissSnackbarActionPerformed(movieId: Long) {
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">        viewModelScope.launch(defaultDispatcher) {</span>
<span class="fc" id="L174">            removeAsHidden(movieId)</span>
<span class="fc" id="L175">            removeAsPendingSwiped(movieId)</span>
<span class="fc" id="L176">        }</span>
<span class="fc" id="L177">    }</span>

    @AnyThread
    private fun removeAllPendingSwipedMovieFromWatchlist() {
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        applicationScope.launch(defaultDispatcher) {</span>
<span class="fc" id="L182">            pendingSwipedMovieItemIds</span>
<span class="fc" id="L183">                .forEach {</span>
<span class="fc" id="L184">                    launch {</span>
<span class="fc" id="L185">                        try {</span>
<span class="fc" id="L186">                            removeFromWatchlistWithTimeout(it)</span>
<span class="nc" id="L187">                        } catch (e: Exception) {</span>
<span class="nc" id="L188">                            Logger.e(e)</span>
                        }
<span class="fc" id="L190">                    }</span>
<span class="fc" id="L191">                }</span>

<span class="fc" id="L193">            pendingSwipedMovieItemIds.clear()</span>
<span class="fc" id="L194">        }</span>
<span class="fc" id="L195">    }</span>

    @WorkerThread
    private suspend fun removeFromWatchlist(movieId: Long) {
<span class="fc" id="L199">        try {</span>
<span class="fc" id="L200">            withContext(NonCancellable) {</span>
<span class="fc" id="L201">                removeFromWatchlistWithTimeout(movieId)</span>
<span class="fc" id="L202">            }</span>
<span class="fc" id="L203">        } catch (e: Exception) {</span>
<span class="fc" id="L204">            removeAsHidden(movieId)</span>
<span class="fc" id="L205">            errorsDispatcher.dispatch(e)</span>
        }
<span class="fc" id="L207">    }</span>

    @AnyThread
    private suspend fun removeFromWatchlistWithTimeout(movieId: Long) {
<span class="fc" id="L211">        withTimeout(REMOVE_FROM_WATCHLIST_TIMEOUT) {</span>
<span class="fc" id="L212">            watchlistInteractor.removeFromWatchlist(movieId)</span>
<span class="fc" id="L213">        }</span>
<span class="fc" id="L214">    }</span>

    @WorkerThread
    private fun addAsHidden(movieId: Long) {
<span class="fc" id="L218">        hiddenMovieItemIds.update { it + movieId }</span>
<span class="fc" id="L219">    }</span>

    @WorkerThread
    private fun removeAsHidden(movieId: Long) {
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">        hiddenMovieItemIds.update { ids -&gt; ids.filter { it != movieId } }</span>
<span class="fc" id="L224">    }</span>

    @WorkerThread
    private fun addAsPendingSwiped(movieId: Long) {
<span class="fc" id="L228">        pendingSwipedMovieItemIds.add(movieId)</span>
<span class="fc" id="L229">    }</span>

    @WorkerThread
    private fun removeAsPendingSwiped(movieId: Long) {
<span class="pc bpc" id="L233" title="2 of 4 branches missed.">        pendingSwipedMovieItemIds.removeIf { it == movieId }</span>
<span class="fc" id="L234">    }</span>

    //endregion

    companion object {
        private const val REMOVE_FROM_WATCHLIST_TIMEOUT = 10_000L
    }

<span class="fc" id="L242">    data class PagingState(</span>
<span class="fc" id="L243">        val loadStates: CombinedLoadStates,</span>
<span class="fc" id="L244">        val itemCount: Int,</span>
    )
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>