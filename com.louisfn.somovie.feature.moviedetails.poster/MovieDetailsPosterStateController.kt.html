<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MovieDetailsPosterStateController.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SoMovie</a> &gt; <a href="index.source.html" class="el_package">com.louisfn.somovie.feature.moviedetails.poster</a> &gt; <span class="el_source">MovieDetailsPosterStateController.kt</span></div><h1>MovieDetailsPosterStateController.kt</h1><pre class="source lang-java linenums">package com.louisfn.somovie.feature.moviedetails.poster

import androidx.annotation.AnyThread
import androidx.annotation.UiThread
import androidx.compose.animation.core.Animatable
import androidx.compose.animation.core.VectorConverter
import androidx.compose.runtime.Composable
import androidx.compose.runtime.Stable
import androidx.compose.runtime.derivedStateOf
import androidx.compose.runtime.getValue
import androidx.compose.runtime.remember
import androidx.compose.runtime.rememberCoroutineScope
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.geometry.Size
import androidx.compose.ui.layout.LayoutCoordinates
import androidx.compose.ui.layout.positionInParent
import androidx.compose.ui.platform.LocalConfiguration
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.toSize
import com.louisfn.somovie.ui.common.extension.roundToPx
import com.louisfn.somovie.ui.common.extension.screenHeightWithInset
import com.louisfn.somovie.ui.common.extension.screenWidth
import com.louisfn.somovie.ui.theme.Dimens
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.launch

<span class="nc" id="L27">private val MinDragDistanceToReduce = 96.dp</span>

<span class="nc" id="L29">@Stable</span>
<span class="nc" id="L30">internal class PosterStateController(</span>
    reducedCoordinates: LayoutCoordinates,
<span class="nc" id="L32">    private val scope: CoroutineScope,</span>
<span class="nc" id="L33">    private val minDragDistanceToReduce: Int,</span>
<span class="nc" id="L34">    private val screenSize: Size,</span>
<span class="nc" id="L35">    private var onStateChanged: (MovieDetailsPosterState) -&gt; Unit,</span>
) {
<span class="nc" id="L37">    private var currentState: MovieDetailsPosterState = MovieDetailsPosterState.REDUCED</span>

<span class="nc" id="L39">    private val reducedSize = reducedCoordinates.size.toSize()</span>
<span class="nc" id="L40">    private val reducedOffset = reducedCoordinates.positionInParent()</span>
<span class="nc" id="L41">    private val expandedSize = Size(width = screenSize.width, height = screenSize.width / Dimens.PosterRatio)</span>
<span class="nc" id="L42">    private val expandedOffset = Offset(x = 0f, y = screenSize.height / 2 - expandedSize.height / 2)</span>

<span class="nc" id="L44">    private var dragOffset = Offset.Zero</span>

<span class="nc" id="L46">    private val sizeAnimatable = Animatable(reducedSize, Size.VectorConverter)</span>
<span class="nc" id="L47">    private val offsetAnimatable = Animatable(reducedOffset, Offset.VectorConverter)</span>

<span class="nc" id="L49">    val size by derivedStateOf { sizeAnimatable.value }</span>
<span class="nc" id="L50">    val offset by derivedStateOf { offsetAnimatable.value }</span>

    @UiThread
    fun animateToState(state: MovieDetailsPosterState) {
<span class="nc" id="L54">        currentState = state</span>
<span class="nc bnc" id="L55" title="All 3 branches missed.">        when (state) {</span>
<span class="nc" id="L56">            MovieDetailsPosterState.EXPANDED -&gt; animateToExpandedState()</span>
<span class="nc" id="L57">            MovieDetailsPosterState.REDUCED -&gt; animateToReducedState()</span>
        }
<span class="nc" id="L59">    }</span>

    @UiThread
    fun onDrag(dragAmount: Offset) {
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (currentState != MovieDetailsPosterState.EXPANDED) return</span>

<span class="nc" id="L65">        dragOffset = dragOffset.plus(dragAmount)</span>

<span class="nc" id="L67">        val newWidth =</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">            if (dragOffset.getDistance() &lt;= minDragDistanceToReduce) {</span>
<span class="nc" id="L69">                screenSize.width - dragOffset.getDistance()</span>
            } else {
<span class="nc" id="L71">                sizeAnimatable.value.width</span>
            }

<span class="nc" id="L74">        val x = (screenSize.width - newWidth) / 2</span>
<span class="nc" id="L75">        val sizeOffset = Offset(x = x, y = x / Dimens.PosterRatio)</span>

<span class="nc" id="L77">        val newOffset = expandedOffset</span>
<span class="nc" id="L78">            .plus(dragOffset)</span>
<span class="nc" id="L79">            .plus(sizeOffset)</span>

<span class="nc" id="L81">        scope.launch { offsetAnimatable.snapTo(newOffset) }</span>
<span class="nc" id="L82">        scope.launch { sizeAnimatable.snapTo(Size(width = newWidth, height = newWidth / Dimens.PosterRatio)) }</span>
<span class="nc" id="L83">    }</span>

    @UiThread
    fun onDragEnd() {
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (currentState != MovieDetailsPosterState.EXPANDED) return</span>

<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (dragOffset.getDistance() &gt; minDragDistanceToReduce) {</span>
<span class="nc" id="L90">            onStateChanged(MovieDetailsPosterState.REDUCED)</span>
        } else {
<span class="nc" id="L92">            animateToExpandedState()</span>
        }

<span class="nc" id="L95">        dragOffset = Offset.Zero</span>
<span class="nc" id="L96">    }</span>

    @AnyThread
    private fun animateToExpandedState() {
<span class="nc" id="L100">        scope.launch { offsetAnimatable.animateTo(expandedOffset) }</span>
<span class="nc" id="L101">        scope.launch { sizeAnimatable.animateTo(expandedSize) }</span>
<span class="nc" id="L102">    }</span>

    @AnyThread
    private fun animateToReducedState() {
<span class="nc" id="L106">        scope.launch { offsetAnimatable.animateTo(reducedOffset) }</span>
<span class="nc" id="L107">        scope.launch { sizeAnimatable.animateTo(reducedSize) }</span>
<span class="nc" id="L108">    }</span>
}

@Composable
internal fun rememberPosterStateController(
    reducedCoordinates: LayoutCoordinates,
    onStateChanged: (MovieDetailsPosterState) -&gt; Unit,
<span class="nc" id="L115">): PosterStateController {</span>
<span class="nc" id="L116">    val scope = rememberCoroutineScope()</span>
<span class="nc" id="L117">    val minDragDistanceToReduce = MinDragDistanceToReduce.roundToPx()</span>
<span class="nc" id="L118">    val screenSize = with(LocalConfiguration.current) { Size(width = screenWidth, height = screenHeightWithInset) }</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">    return remember(reducedCoordinates) {</span>
<span class="nc" id="L121">        PosterStateController(</span>
<span class="nc" id="L122">            minDragDistanceToReduce = minDragDistanceToReduce,</span>
<span class="nc" id="L123">            reducedCoordinates = reducedCoordinates,</span>
<span class="nc" id="L124">            screenSize = screenSize,</span>
<span class="nc" id="L125">            onStateChanged = onStateChanged,</span>
<span class="nc" id="L126">            scope = scope,</span>
        )
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>